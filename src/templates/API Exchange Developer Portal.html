<!DOCTYPE html>
<!-- saved from url=(0057)https://portal.axpuat.cpf.gov.sg/test_workspace_01/guides -->
<html sigplusextliteextension-installed="true" extension-version="2.0.15.0">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>API Exchange Developer Portal</title>
  <!--<base href="https://portal.axpuat.cpf.gov.sg/test_workspace_01/">--><base href=".">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">

  <style>
    /* Values */
    :root {

        --hero: #0A6160;

        --text_hero: #FFFFFF;

        --header: #FFFFFF;

        --accent: #3C9392;

        --page: #FFFFFF;

        --text_links: #0A6160;

        --text_headings: #000000;

    }

    /* Utilities */

    .color-hero {
      color: var(--hero);
    }

    .bg-hero {
      background-color: var(--hero);
    }

    .color-text_hero {
      color: var(--text_hero);
    }

    .bg-text_hero {
      background-color: var(--text_hero);
    }

    .color-header {
      color: var(--header);
    }

    .bg-header {
      background-color: var(--header);
    }

    .color-accent {
      color: var(--accent);
    }

    .bg-accent {
      background-color: var(--accent);
    }

    .color-page {
      color: var(--page);
    }

    .bg-page {
      background-color: var(--page);
    }

    .color-text_links {
      color: var(--text_links);
    }

    .bg-text_links {
      background-color: var(--text_links);
    }

    .color-text_headings {
      color: var(--text_headings);
    }

    .bg-text_headings {
      background-color: var(--text_headings);
    }


    /* Font Families */
    body {
      font-family: "", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }
    pre,code,kbd {
      font-family: inherit;
      font-family: "";
    }
    h1, h2, h2, h3, h4, h5, h6 {
      font-family: "", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }

    #editor { 
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 8cm;
          margin-bottom: 3rem;
      }
    
    .styled-table {
      border-collapse: collapse;
      margin: 25px 0;
      font-size: 0.9em;
      font-family: sans-serif;
      min-width: 400px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
    }

    .styled-table thead th {
      background-color: #0A6160;
      color: #ffffff;
      text-align: left;
    }

    .styled-table .secondary-col {
      width: 100%;
    }

    .styled-table th,
    .styled-table td {
      padding: 15px !important;
    }

    .styled-table tbody tr {
      border-bottom: 1px solid #dddddd;
    }

    .styled-table tbody tr:nth-of-type(even) {
      background-color: #f3f3f3;
    }

    .styled-table tbody tr:last-of-type {
      border-bottom: 2px solid #0A6160;
    }

    .styled-table tbody tr.active-row {
      font-weight: bold;
      color: #009879;
    }

    th:first-of-type {
      border-top-left-radius: 10px;
    }

    th:last-of-type {
      border-top-right-radius: 10px;
    }

    tr:last-of-type td:first-of-type {
      border-bottom-left-radius: 10px;
    }

    tr:last-of-type td:last-of-type {
      border-bottom-right-radius: 10px;
    }

    #loading {
      position: fixed;
      display: none;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      text-align: center;
      opacity: 0.7;
      background-color: #fff;
      z-index: 99;
    }

    #loading-image {
      position: absolute;
      top: 100px;
      left: 240px;
      z-index: 100;
    }

    /* invisible scrollbar */
    #errorTextArea::-webkit-scrollbar {
      display: none;
    }

    #errorTextArea {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    button:active {
      border: none;
    }


  </style>

  <link href="static/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="static/css/highlight.min.css" rel="stylesheet" type="text/css">
  <link href="static/css/framework.min.css" rel="stylesheet" type="text/css">
  <link href="static/css/site.css" rel="stylesheet" type="text/css">

</head>

<body>
    
  <header class="site-header">
    <div class="container"  style="float: left; margin-left: 1cm">
      <div class="row">
        <div class="four columns">
          <h1 class="brand"><a href="https://portal.axpuat.cpf.gov.sg/test_workspace_01"><img class="logo" src="/static/images/Logo.png" alt="API Exchange Developer Portal"></a></h1>
        </div>
      </div>
    </div>
  </header>

  <div style="padding-top: 3cm; padding-left: 1cm">
    <h3 class="route-identifier">CPF OAS Validator Tool</h3>
    <p style="margin-bottom: 2rem !important;">Paste the content of your OAS in the field below, and wait 2 seconds to check if there are any errors on the OAS format.</p>
  </div>
    

  <div class="page vh-100" style="display:flex; flex-direction: row; padding-top: 0">
    <div class="container h-100 py-5 d-flex flex-column" style="margin: 0; width: 70%; flex: 1; padding: 1cm">
      <!-- OAS Text Box -->
      <div style="position: relative">
        <div id="editor" contenteditable="true" spellcheck="true" style="height: 10cm">
          <textarea id="oasTextarea" class="form-control flex-fill" method="post" wrap="off" style="font-size:1.5rem; margin-bottom: 2rem;height:100%; height: 100%;"></textarea>
        </div>
      </div>
      <div style="margin-top: 10.5cm; text-align: right;">
        <!-- Upload Feature -->
        <input class="my-0 align-self-start" id="fileUpload" type="file" style="margin-bottom: 3rem; padding-bottom: 1cm; float: left;", accept=".yml, .yaml, .json" onclick="this.value=null" onchange="uploadFile()"/>
        <input type="hidden" id="fileNameInput">
        <!-- <button class = "my-0 px-5 align-self-start" id="fileUploadButton" style="display: inline-block;" onclick=uploadFile()>Upload</button> -->
        <!-- Save Text to File Feature -->
        <button class = "my-0 px-5 align-self-start" id="savefile" style="display: inline-block" onclick="saveFile()">Save to File</button>
        <!-- Check OAS -->
        <!-- <button class="btn noBorder my-0 px-5 align-self-start" id="checkOASButton" style="background-color: rgb(10, 97, 96); color: white; font-size: 1em; text-transform: none; height: auto; padding: 8px 15px; border-radius: 5px; margin-bottom: 5rem;" onclick=extractOAS()>How is my OAS?</button> -->
    </div>
    <div>
      <!-- Dictionary Text Box -->
      <p wrap="on" style="margin-bottom: 2rem !important; margin-top: 1rem !important;">Paste dictionary word here (from least important to most important order):</p>
      <grammarly-editor-plugin contenteditable="true">
        <textarea id="oasDictionaryArea" class="form-control flex-fill" wrap="off" style="font-size:1.5rem; margin-bottom: 2rem; width: 50%; height: 3cm;">
discretionary
withdrawals
update
member
credit
status
for
pay
now
eligibility
check
age</textarea></grammarly-editor-plugin>
    </div>
  </div>
  <div class="container h-100 py-5 d-flex flex-column" style="margin: 0; width: 35%; padding-right: 1cm; ">
    <textarea name="errorTextArea" id="errorTextArea" cols="30" rows="10" style="height: 10cm; border: none; outline: none; resize: none; padding-top: 0; font-size: 15px; line-height: 18px;" readonly></textarea>
    <div>
      <div class="card text-white bg-success mb-3" style="width: 100%; max-width: 15rem; margin-left: 1cm; margin-top: 0.5cm; display:inline-block">
        <div class="card-body">
          <p class="card-text" id="errorCount" style="text-align: center;">Valid</p>
        </div>
      </div>
      <div style="display: inline-block">
        <button id="errorScroller">Next Error</button>
      </div>
    </div>
    
  </div>
</div>

  <div id="spec-url" style="display: none">
    documentation/untitled
  </div>

  <!-- Modals -->
  <link href="static/css/swagger-ui.css" rel="stylesheet" type="text/css">
  <div class="modal fade" id="oasSuccess" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content" style="min-height:100%;">
        <div class="modal-header">
          <h5 class="modal-title" id="staticSuccessBackdropLabel">OAS Checker</h5>
          <button type="button" class="btn-close noBorder" style="padding:1rem 2rem;" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="oasSuccessBody">
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="oasErrors" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content" style="min-height:100%;">
        <div class="modal-header">
          <h5 class="modal-title" id="staticErrorsBackdropLabel">OAS Checker</h5>
          <button type="button" class="btn-close noBorder" style="padding:1rem 2rem;" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body"> 
            <table class = "styled-table">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col" class="secondary-col">Errors</th>
                  </tr>
                </thead>
                <tbody id="oasErrorsBody">
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/js/bootstrap.bundle.min.js.download"></script>
  <script src="/static/js/swagger-ui-bundle.js.download"></script>
  <script src="/static/js/js-yaml-3.13.1.min.js.download"></script>
  <script src="/static/js/jquery.min.js.download"></script>
  <!-- need to find a way to phase grammarly out or hide the api key -->
  <script src="https://cdn.jsdelivr.net/npm/@grammarly/editor-sdk?clientId=client_4CtRAfLPVnqc476pJ7F7xT"></script>
  <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.19.0/src-min-noconflict/ace.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/ace-builds@1.19.0/css/ace.min.css" rel="stylesheet">

  <script>
    var editor = ace.edit("editor");
    var Range = ace.require("ace/range").Range;
    editor.setTheme("ace/theme/kuroir");
    editor.getSession().setMode("ace/mode/yaml");
    document.getElementById('editor').style.fontSize='15px';
    editor.setOption({
      enableBasicAutocompletion: true,
      fontFamily: "tahoma",
      enableSnippets: true,
      enableLiveAutocompletion: true
    });
    // editor.session.setOption("useWorker", false); // disables syntax checking
    var errorCounterFlag = false;

    // Sync Scrolling
    $('.ace_scrollbar-v').scroll(function () {
      $("#errorTextArea").scrollTop($('.ace_scrollbar-v').scrollTop());
      $("#errorTextArea").scrollLeft($('.ace_scrollbar-v').scrollLeft());
    });
    $("#errorTextArea").scroll(function () {
      $(".ace_scrollbar-v").scrollTop($("#errorTextArea").scrollTop());
      $(".ace_scrollbar-v").scrollLeft($("#errorTextArea").scrollLeft());
    })

    function uploadFile() {
        var file = document.getElementById("fileUpload").files[0];
        if (file != undefined) {
          var reader = new FileReader();
          reader.onload = function(e) {
          editor.setValue(e.target.result);
          }
          reader.readAsText(file);
        } else {
          alert("No file provided!");
        }
      }

    // $('#fileUpload').on

    function saveFile() {
      var textArea = editor.getValue();
      if (textArea == "") {
        alert("Please input an OAS before saving to file!");
        return;
      } else if (fileName = prompt("Save file as", "")) {
        var textBlob = new Blob([textArea], {type:"text/plain"});
        var downloadLink = document.createElement("a");
        downloadLink.download = fileName;
        downloadLink.innerHTML = textBlob;
        if (window.webkitURL != null) { // Chrome
          downloadLink.href = window.webkitURL.createObjectURL(textBlob);
        } else { // Firefox
          downloadLink.href = window.URL.createObjectURL(textBlob);
          downloadLink.onclick = destroyClickedElement;
          downloadLink.style.display = "none";
          document.body.appendChild(downloadLink);
        }
        downloadLink.click();
      }
    }

    // =========================================================================================================================

    // Updates error counter
    function updateErrorCounter() {
      var errorCount = 0;
      var errorPanel = document.getElementById("errorTextArea").innerHTML;
      
      errorTextArea_array = errorPanel.split("\n");
      for (let i = 0; i < errorTextArea_array.length; i++) {
        if (errorTextArea_array[i] != "") {
          errorCount += 1;
        }
      }

      if (errorCount == 0) {
        document.getElementById('errorCount').innerHTML = "Valid";
      } else {
        document.getElementById('errorCount').innerHTML = "No. of Errors: " + (errorCount);
      }
    }

    // Real-time side panel refresh by posting to backend
    // Using debounce concept to buffer each post request
    var debounce = null;
    editor.getSession().on("change", function (e) {
      clearTimeout(debounce);
      debounce = setTimeout(function extractOAS () {
          // $(document).ready(function() {
          // $('#checkOASButton').unbind('click').on('click', function(e) {
          
          // e.preventDefault();
          // e.stopImmediatePropagation();

          var data = editor.getValue();
          if (data.trim() == "" || data == undefined) {
            return;
          }

          // Catches one indentation error at a time
          // Make sure user handles all indentation errors before checking OAS
          // Shows and highlights rows with indentation errors in editor and side panel
          var syntaxErrors = editor.getSession().getAnnotations();
          if (syntaxErrors.length != 0) {
            line = syntaxErrors[0]["row"];
            errorText = syntaxErrors[0]["text"];
            errorType = syntaxErrors[0]["type"];
            editor.gotoLine(line); // thinking about how to improve this
            var highlightRange = new Range(line, 0, line, 300);
            editor.selection.setRange(highlightRange);
            editor.session.addMarker(highlightRange, "error", "text");
            // var customAnnotations = [
            // {
            //   row: line + 5,
            //   column: 0,
            //   text: "test", // or the json reply from the parser
            //   type: "error" // also "warning" and "information"
            // },
            // {
            //   row: line + 10,
            //   column: 0,
            //   text: "test", // or the json reply from the parser
            //   type: "error" // also "warning" and "information"
            // }]
            // editor.getSession().setAnnotations(syntaxErrors.concat(customAnnotations))
            return;
          }

          // console.log(editor.getSession().getAnnotations())
          // editor.session.setOption("useWorker", false) # use when the annotations disappear
          // editor.getSession().setAnnotations([{
          //   row: 1,
          //   column: 0,
          //   text: "test", // or the json reply from the parser
          //   type: "error" // also "warning" and "information"
          // }])

          // editor.session.addMarker(new Range(startRow, startColumn, endRow, endColumn), className, type: ["text", "fullLine", "screenLine"], inFront (opt))

          // var highlightRange = new Range(10, 0, 10, 300);
          // editor.selection.setRange(highlightRange);
          // editor.session.addMarker(highlightRange, "error", "text");

          // editor.getSession().setAnnotations([{
          //     row: 3,
          //     column: 0,
          //     text: "test",
          //     type: "error"
          // }, {
          //     row: 5,
          //     column: 5,
          //     text: "test2",
          //     type: "error"
          // }])

          // console.log(editor.getSession().getAnnotations())


          // console.log(editor.getSession().getValue());
          // session.getLength() --> Gets total number of lines of the yaml file
          // session.getLine(line) --> Gets the string value of the line at line <line>
          // session.getLines(line1, line2) --> Gets the string values of line 1 and line 2 
          // gotoLine(line) --> Scrolls the screen down to line <line>

          
          var dictionaryWords = $('#oasDictionaryArea').val().split(/\r?\n/);
          var dictionaryWordsDictionary = {dictionary: dictionaryWords};
          dictionary = JSON.stringify(dictionaryWordsDictionary);
          
          $('#loading').show();
          
          $.ajax({
            data: {
              doc: data,
              dictionary: dictionary,
            },
            type: 'POST',
            url: '/checkOAS',
            success: function(response) {
              $('#loading').hide();
              // oasSuccessModal = $('#oasSuccess');
              // oasSuccessModal.find('.modal-body').html(`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg>`);
              // oasSuccessModal.find('.modal-body').append("There are no additional errors found");
              // oasSuccessModal.modal("show");

              // fill with empty lines in error side panel
              var errorTextArea = document.getElementById("errorTextArea");
              var numLines = editor.session.getLength();
              var emptyLines = "\n".repeat(numLines - 1);
              errorTextArea.innerHTML = emptyLines;
            },
            error: function(response) {
              $('#loading').hide();
              var listErrors = response["responseJSON"]["errors"];
              var dictErrors = {};
              
              // oasErrorModal = $('#oasErrors');
              // oasErrorModal.find('.styled-table tbody').empty();
              for (let i = 0; i < listErrors.length; i++){
                var errorText = listErrors[i][0];
                var errorLine = listErrors[i][1];
                var errorColumn = listErrors[i][2];
                // oasErrorModal.find('.styled-table tbody').append(`<tr>
                //                                             <td scope="row">`+(errorLine)+`</th>
                //                                             <td>`+(errorText)+`</td>
                //                                           </tr>
                //                                         `);
                dictErrors[errorLine] = [errorText, errorColumn];
              }
              // oasErrorModal.modal("show");

              // fill lines without errors with empty lines while those with with error description
              var errorTextArea = document.getElementById("errorTextArea");
              var emptyLines = "";
              var numLines = editor.session.getLength();
              // TODO: Check for errors on the same line and combine the error description
              for (let i = 0; i < numLines; i++) {
                if (dictErrors[i] != undefined) {
                  emptyLines += `${dictErrors[i][0]} @ line number ${i + 1}`;
                } 
                if (i == numLines - 1) {
                  break;
                }
                emptyLines += "\n";
              }
              errorTextArea.innerHTML = emptyLines;
            },
            complete: function() {
              errorCounterFlag = false;
              updateErrorCounter();
            }
          });
      }, 1500);
    });

    var errorLines_queue = [];
    $('#errorScroller').on('click', function () {
      if (errorCounterFlag == false) { // error list newly updated
        errorLines_queue = [];
        var errorPanel = document.getElementById("errorTextArea").innerHTML;
        errorTextArea_array = errorPanel.split("\n");
        for (let i = 0; i < errorTextArea_array.length; i++) {
          if (errorTextArea_array[i] != "") {
            errorLines_queue.push(i + 1);
          }
        }
        if (errorLines_queue.length == 0) {
          return;
        } else {
          nextErrorLine = errorLines_queue.shift();
          errorLines_queue.push(nextErrorLine);
          errorCounterFlag = true;
          editor.gotoLine(nextErrorLine);
        }
      } else { // same session
        if (errorLines_queue.length == 0) {
          return;
        }
        nextErrorLine = errorLines_queue.shift();
        errorLines_queue.push(nextErrorLine);
        editor.gotoLine(nextErrorLine);
      }
    })
  </script>
    
<script src="/static/js/kong.utils.js.download"></script>

</body>

<div id="loading">
  <img id="loading-image" src="/static/images/ajax-loader.gif" alt="Loading..." />
</div>

</html>

