<!DOCTYPE html>
<!-- saved from url=(0057)https://portal.axpuat.cpf.gov.sg/test_workspace_01/guides -->
<html sigplusextliteextension-installed="true" extension-version="2.0.15.0">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>API Exchange Developer Portal</title>
  <!--<base href="https://portal.axpuat.cpf.gov.sg/test_workspace_01/">--><base href=".">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">

  <style>
    /* Values */
    :root {

        --hero: #0A6160;

        --text_hero: #FFFFFF;

        --header: #FFFFFF;

        --accent: #3C9392;

        --page: #FFFFFF;

        --text_links: #0A6160;

        --text_headings: #000000;

    }

    /* Utilities */

    .color-hero {
      color: var(--hero);
    }

    .bg-hero {
      background-color: var(--hero);
    }

    .color-text_hero {
      color: var(--text_hero);
    }

    .bg-text_hero {
      background-color: var(--text_hero);
    }

    .color-header {
      color: var(--header);
    }

    .bg-header {
      background-color: var(--header);
    }

    .color-accent {
      color: var(--accent);
    }

    .bg-accent {
      background-color: var(--accent);
    }

    .color-page {
      color: var(--page);
    }

    .bg-page {
      background-color: var(--page);
    }

    .color-text_links {
      color: var(--text_links);
    }

    .bg-text_links {
      background-color: var(--text_links);
    }

    .color-text_headings {
      color: var(--text_headings);
    }

    .bg-text_headings {
      background-color: var(--text_headings);
    }


    /* Font Families */
    body {
      font-family: "", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }
    pre,code,kbd {
      font-family: inherit;
      font-family: "";
    }
    h1, h2, h2, h3, h4, h5, h6 {
      font-family: "", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }

    #editor { 
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 8cm;
          margin-bottom: 3rem;
          border: 2px solid #000;
          border-radius: 5px;
      }
    
    .styled-table {
      border-collapse: collapse;
      margin: 25px 0;
      font-size: 0.9em;
      font-family: sans-serif;
      min-width: 400px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
    }

    .styled-table thead th {
      background-color: #0A6160;
      color: #ffffff;
      text-align: left;
    }

    .styled-table .secondary-col {
      width: 100%;
    }

    .styled-table th,
    .styled-table td {
      padding: 15px !important;
    }

    .styled-table tbody tr {
      border-bottom: 1px solid #dddddd;
    }

    .styled-table tbody tr:nth-of-type(even) {
      background-color: #f3f3f3;
    }

    .styled-table tbody tr:last-of-type {
      border-bottom: 2px solid #0A6160;
    }

    .styled-table tbody tr.active-row {
      font-weight: bold;
      color: #009879;
    }

    th:first-of-type {
      border-top-left-radius: 10px;
    }

    th:last-of-type {
      border-top-right-radius: 10px;
    }

    tr:last-of-type td:first-of-type {
      border-bottom-left-radius: 10px;
    }

    tr:last-of-type td:last-of-type {
      border-bottom-right-radius: 10px;
    }

    #loading {
      position: fixed;
      display: none;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      text-align: center;
      opacity: 0.7;
      background-color: #fff;
      z-index: 99;
    }

    #loading-image {
      position: absolute;
      top: 100px;
      left: 240px;
      z-index: 100;
    }

    button:active {
      border: none;
    }

    .navbar {
      position: fixed !important;
      top: 0;
      width: 100%;
      z-index: 2;
    }
    
    .navbar .dropdown-item {
      font-size: 16px; /* Adjust the font size as needed */
      padding: 10px 20px; /* Adjust the padding values as needed */
    }

    .dropdown:hover .dropdown-menu {
      display: block;
    }

    .dropdown-menu {
      display: none;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      z-index: 3;
    }

    #errorPanel.active, #previewPanel.active {
      display: block !important;
    }

    @media (max-width: 576px) {
      .navbar {
        padding: 5px;
      }

      .navbar .nav-link {
        font-size: 5px;
      }
    }

    /* Styles for medium screens */
    @media (min-width: 576px) {
      .navbar {
        padding: 10px;
      }

      .navbar .nav-link {
        font-size: 10px;
      }
    }

    /* Styles for large screens */
    @media (min-width: 992px) {
      .navbar {
        padding: 12px;
      }

      .navbar .nav-link {
        font-size: 12px;
      }
    }

    /* Styles for extra large screens */
    @media (min-width: 1200px) {
      .navbar {
        padding: 16px;
      }

      .navbar .nav-link {
        font-size: 16px;
      }
    }

  </style>

  <link href="static/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="static/css/highlight.min.css" rel="stylesheet" type="text/css">
  <link href="static/css/framework.min.css" rel="stylesheet" type="text/css">
  <link href="static/css/site.css" rel="stylesheet" type="text/css">
  <link href="static/css/swagger-ui.css" rel="stylesheet" type="text/css">
  <link href="https://cdn.jsdelivr.net/npm/ace-builds@1.19.0/css/ace.min.css" rel="stylesheet">

</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-light bg-light" style="height:60px; border-bottom: 1px solid #000;">
    <div class="container-fluid">
      <a class="navbar-brand" href="https://portal.axpuat.cpf.gov.sg/test_workspace_01">
        <img class="logo" src="/static/images/Logo.png" alt="API Exchange Developer Portal" style="max-height: 32px; padding-right: 1cm;">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <ul class="navbar-nav">
          <li class="nav-item dropdown" style="margin-bottom: 0; width: 75px">
            <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              File
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
              <li>
                <a class="dropdown-item" onclick="pickFile()">Import File</a>
              </li>
              <li role="separator"></li>
              <li><a class="dropdown-item" onclick="saveFile()">Save File</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown" style="margin-bottom: 0; width: 75px">
            <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Dictionary
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
              <li><a class="dropdown-item" onclick="editDictionary()">Edit Dictionary</a></li>
              <li><a class="dropdown-item" onclick="uploadDictionary()">Upload Dictionary</a></li>
            </ul>
          </li>
        </ul>
      </div>
      <span class="navbar-text">CPF OAS Validator Tool</span>
    </div>
  </nav>
    
  <div class="split-pane" style="display: flex; flex: 1 1 0%; height: 100%; position: absolute; outline: none; overflow: hidden; user-select: text; flex-direction: row; left: 0px; right: 0px; padding-top: 60px">
    <!-- Ace Editor -->
    <div class="pane-left" style="flex: 1 1 0%; position: relative;">
      <div class="container-fluid">
        <div id="editor" contenteditable="true" style="height: 100%;"></div>
      </div>
    </div>

    <!-- TODO: Resizer -->
    <div class="resizer" style="width: 5px; cursor: col-resize; background-color: #ccc"></div>
    
    <div class="pane-right" style="flex: 1 1 0%; overflow: auto;">
      <div class="container-fluid">
        <!-- Error Panel -->
        <div class="accordion" id="errorPanel" style="display: none"></div>
        <!-- Preview Panel -->
        <div id="previewPanel" style="display: none">
          <div id="oasPreviewBody"></div>
        </div>
      </div>

    </div>
  </div>


  <div id="spec-url" style="display: none">
    documentation/untitled
  </div>

  <!-- Modals -->
  <!-- Custom Dictionary -->
  <div class="modal fade" id="dictionaryModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content" style="min-height:100%;">
        <div class="modal-header">
          <h5 class="modal-title">Custom Dictionary</h5>
          <button type="button" class="btn-close noBorder" style="padding:1rem 2rem;" data-bs-dismiss="modal" onclick="saveDictionary()"></button>
        </div>
        <div class="modal-body">
          <p style="padding-bottom: 5px">English words in the US and UK dictionaries are automatically included.</p>
          <textarea id="customDictionary" class="form-control flex-fill" wrap="off" style="font-size:1.5rem; width: 100%; height: 10cm;">
paynow
electronicform</textarea>
            <button type="button" class="btn" data-bs-dismiss="modal" onclick="saveDictionary()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/js/bootstrap.bundle.min.js.download"></script>
  <script src="/static/js/swagger-ui-bundle.js."></script>
  <script src="/static/js/swagger-ui-standalone-preset.js"></script>
  <script src="/static/js/js-yaml-3.13.1.min.js.download"></script>
  <script src="/static/js/jquery.min.js.download"></script>
  <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.19.0/src-min-noconflict/ace.min.js"></script>

  <script>
    // TODO: Light and Dark mode
    var editor = ace.edit("editor");
    var Range = ace.require("ace/range").Range;
    editor.setTheme("ace/theme/kuroir");
    editor.getSession().setMode("ace/mode/yaml");
    document.getElementById('editor').style.fontSize='15px';
    editor.setOption({
      enableBasicAutocompletion: true,
      fontFamily: "tahoma",
      enableSnippets: true,
      enableLiveAutocompletion: true
    });
    const errorPanel = document.getElementById('errorPanel');
    const previewPanel = document.getElementById('previewPanel');

    function pickFile() {
      const fileInput = document.createElement("input");
      fileInput.id = "fileUpload";
      fileInput.type = "file";
      fileInput.accept = ".yml, .yaml, .json";
      fileInput.onclick = "this.value=null";
      fileInput.addEventListener("change", function(event) {
        uploadFile(event)
      })
      fileInput.click();
    }

    function uploadFile(event) {
      const file = event.target.files[0]
      if (file) {
        var reader = new FileReader();
        reader.onload = function(e) {
        editor.setValue(e.target.result);
        }
        reader.readAsText(file);
      }
    }

    function saveFile() {
      var textArea = editor.getValue();
      if (textArea == "") {
        alert("Please input an OAS before saving to file!");
        return;
      } else if (fileName = prompt("Save file as", "")) {
        var textBlob = new Blob([textArea], {type:"text/plain"});
        var downloadLink = document.createElement("a");
        downloadLink.download = fileName;
        downloadLink.innerHTML = textBlob;
        if (window.webkitURL != null) { // Chrome
          downloadLink.href = window.webkitURL.createObjectURL(textBlob);
        } else { // Firefox
          downloadLink.href = window.URL.createObjectURL(textBlob);
          downloadLink.onclick = destroyClickedElement;
          downloadLink.style.display = "none";
          document.body.appendChild(downloadLink);
        }
        downloadLink.click();
      }
    }

    function editDictionary() {
      var dictionaryModal = new bootstrap.Modal(document.getElementById("dictionaryModal"));
      dictionaryModal.show();
    }

    function saveDictionary() {
      editor.setValue("");
    }

    function addAccordionItem(id, errorLine, errorKeyword, errorMessage, errorAdditionalInfo) {
      var newItemId =  'item' + id + Date.now();

      const br = document.createElement("br");

      var newItem = document.createElement('div');
      newItem.classList.add('accordion-item');
      newItem.setAttribute('style', 'margin-bottom: 10px');

      var newItemHeader = document.createElement('div');
      newItemHeader.classList.add('accordion-header');
      newItemHeader.id = newItemId + '-header';

      var newItemButton = document.createElement('button');
      newItemButton.classList.add('accordion-button');
      newItemButton.setAttribute('type', 'button');
      newItemButton.setAttribute('data-bs-toggle', 'collapse');
      newItemButton.setAttribute('data-bs-target', '#' + newItemId + '-collapse');
      newItemButton.setAttribute('aria-expanded', "false");
      newItemButton.setAttribute('aria-controls', newItemId + '-collapse');
      newItemButton.setAttribute('style', 'margin-bottom: 0');
      newItemButton.setAttribute('data-line', errorLine);
      newItemButton.textContent = "Line " + errorLine + " --- " + errorKeyword;

      var newItemCollapse = document.createElement('div');
      newItemCollapse.classList.add('accordion-collapse', 'collapse');
      newItemCollapse.setAttribute('id', newItemId + '-collapse');
      newItemCollapse.setAttribute('aria-labelledby', newItemId + '-header');
      newItemCollapse.setAttribute('data-bs-parent', '#accordion');

      var newItemBody = document.createElement('div');
      newItemBody.classList.add('accordion-body');
      newItemBody.innerHTML += errorAdditionalInfo[0] + ": " + errorAdditionalInfo[1];
      newItemBody.appendChild(br);
      newItemBody.innerHTML += errorMessage; 

      newItemHeader.appendChild(newItemButton);
      newItemCollapse.appendChild(newItemBody);
      newItem.appendChild(newItemHeader);
      newItem.appendChild(newItemCollapse);

      var accordionContainer = document.getElementById('errorPanel');
      accordionContainer.appendChild(newItem); 
    }

    function refreshAccordion() {
      var accordionContainer = document.getElementById('errorPanel');
      accordionContainer.innerHTML = '';
    }

    function previewOAS(data) {
      var swaggerUIOptions = {
        dom_id: '#oasPreviewBody', // Determine what element to load swagger ui
        presets: [
          SwaggerUIBundle.presets.apis,
          SwaggerUIBundle.SwaggerUIStandalonePreset
        ],
        plugins: [
          SwaggerUIBundle.plugins.DownloadUrl
        ],
        layout: 'BaseLayout',
      }
      swaggerUIOptions.spec = jsyaml.load(data, {schema:jsyaml.JSON_SCHEMA})
      SwaggerUIBundle(swaggerUIOptions)
    }


    // =========================================================================================================================

    // Real-time side panel refresh after each validation response
    // Using debounce to buffer each post request by DEBOUNCE_BUFFER
    let debounce;
    const DEBOUNCE_BUFFER = 1500;
    editor.getSession().on("change", function (e) {
      var editorBorder = document.querySelector('#editor');
      editorBorder.style.border = '2px solid #000';

      clearTimeout(debounce);
      debounce = setTimeout(function extractOAS () {
          var data = editor.getValue();
          if (data.trim() == "" || data == undefined) {
            errorPanel.classList.remove('active');
            previewPanel.classList.remove('active')
            return;
          }

          // Catches one indentation error at a time
          // Make sure user handles all indentation errors before checking OAS
          // Shows and highlights row with indentation errors in editor
          var syntaxErrors = editor.getSession().getAnnotations();
          if (syntaxErrors.length != 0) {
            line = syntaxErrors[0]["row"];
            errorText = syntaxErrors[0]["text"];
            errorType = syntaxErrors[0]["type"];
            editor.gotoLine(line); // thinking about how to improve this
            var highlightRange = new Range(line, 0, line, 300);
            editor.selection.setRange(highlightRange);
            editor.session.addMarker(highlightRange, "error", "text");
            // var customAnnotations = [
            // {
            //   row: line + 5,
            //   column: 0,
            //   text: "test", // or the json reply from the parser
            //   type: "error" // also "warning" and "information"
            // },
            // {
            //   row: line + 10,
            //   column: 0,
            //   text: "test", // or the json reply from the parser
            //   type: "error" // also "warning" and "information"
            // }]
            // editor.getSession().setAnnotations(syntaxErrors.concat(customAnnotations))
            return;
          }

          // console.log(editor.getSession().getAnnotations())
          // editor.session.setOption("useWorker", false) # use when the annotations disappear
          // editor.getSession().setAnnotations([{
          //   row: 1,
          //   column: 0,
          //   text: "test", // or the json reply from the parser
          //   type: "error" // also "warning" and "information"
          // }])

          // editor.session.addMarker(new Range(startRow, startColumn, endRow, endColumn), className, type: ["text", "fullLine", "screenLine"], inFront (opt))

          // var highlightRange = new Range(10, 0, 10, 300);
          // editor.selection.setRange(highlightRange);
          // editor.session.addMarker(highlightRange, "error", "text");

          // editor.getSession().setAnnotations([{
          //     row: 3,
          //     column: 0,
          //     text: "test",
          //     type: "error"
          // }, {
          //     row: 5,
          //     column: 5,
          //     text: "test2",
          //     type: "error"
          // }])

          // console.log(editor.getSession().getAnnotations())


          // console.log(editor.getSession().getValue());
          // session.getLength() --> Gets total number of lines of the yaml file
          // session.getLine(line) --> Gets the string value of the line at line <line>
          // session.getLines(line1, line2) --> Gets the string values of line 1 and line 2 
          // gotoLine(line) --> Scrolls the screen down to line <line>

          
          var dictionaryWords = $('#customDictionary').val().split(/\r?\n/);

          $('#loading').show();

          $.ajax({
            data: JSON.stringify({
              doc: data,
              dictionary: dictionaryWords,
            }),
            method: 'POST',
            contentType: 'application/json',
            url: 'http://localhost:80/validate',
            success: function(response) {
              $('#loading').hide();

              refreshAccordion();

              previewOAS(data);

              errorPanel.classList.remove('active');
              previewPanel.classList.add('active')
              
              editorBorder.style.border = '2px solid #20c997';
            },
            error: function(response) {
              $('#loading').hide();
              var listErrors = JSON.parse(response["responseText"]) // list of dictionary objects

              refreshAccordion();

              previewPanel.classList.remove('active');
              errorPanel.classList.add('active')

              var formattedErrors = []
              for (let i = 0; i < listErrors.length; i++){
                var id = i;
                var errorLine = listErrors[i]["line_number"];
                var errorKeyword = listErrors[i]["keyword"];
                var errorMessage = listErrors[i]["error_message"];
                
                var errorAdditionalInfo = listErrors[i]["params"]
                formattedErrors.push({
                  id: id,
                  errorLine: errorLine,
                  errorKeyword: errorKeyword,
                  errorMessage: errorMessage,
                  errorAdditionalInfo: errorAdditionalInfo
                })
              }

              formattedErrors.sort((a, b) => a.errorLine - b.errorLine);

              for (var error of formattedErrors) {
                id = error["id"]
                errorLine = error["errorLine"];
                errorKeyword = error["errorKeyword"];
                errorMessage = error["errorMessage"];
                errorAdditionalInfo = Object.entries(error["errorAdditionalInfo"]);
                errorAdditionalInfo = [errorAdditionalInfo[0][0], errorAdditionalInfo[0][1]]
                addAccordionItem(id, errorLine, errorKeyword, errorMessage, errorAdditionalInfo);
              }
              
              editorBorder.style.border = '2px solid #f00';
            },
            complete: function() {
              console.log("Done")
            }
          });
      }, DEBOUNCE_BUFFER);
    });


    $('#errorPanel').on('click', '.accordion-button:not(.collapsed)', function() {
      var errorLine = parseInt($(this).data("line")) - 1 // ace editor treats first line as 0
      editor.gotoLine(errorLine);
      var highlightRange = new Range(errorLine, 0, errorLine, 300);
      editor.selection.setRange(highlightRange);
    })
 
  </script>
    
<script src="/static/js/kong.utils.js.download"></script>

</body>

<div id="loading">
  <img id="loading-image" src="/static/images/ajax-loader.gif" alt="Loading..." />
</div>

</html>

